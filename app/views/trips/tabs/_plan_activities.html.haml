%div{'ng-controller' => 'ActivitiesPlanController'}
  .work-area-header
    .row
      .col-md-12
        = render 'trips/partials/tabs'
    = render 'trips/partials/watching_users'
    = render 'trips/partials/budget', options: {tab_budget: 'activities_other_budget'}
    .row.hidden-xs.sticky-row{'sticky' => 'true'}
      .col-md-12
        = render 'trips/partials/buttons'

  .activities
    - @trip.days.each do |day|
      .activity{'ng-controller' => 'ActivitiesDayController',
                'ng-init' => "load(#{@trip.id}, #{day.id}, {#{default_currency_hash(@trip, current_user)}, rating: 2})",
                'ng-class' => '{shadowed: reloading}'}
        .activity-content{'ng-show' => 'day_loaded', 'ng-cloak' => ''}
          .row.activity-day-header
            .col-xs-12
              .activity-day-date{'ng-click' => 'triggerShowMore()'}
                = day.date_when_s

              .activities-actions
                - if @user_can_edit
                  - if @trip.days.count > 1
                    .activity-action-link.hidden-xs{'ng-controller' => 'DaySorterController', 'ng-hide' => 'edit'}
                      %a.link-with-icon{'ng-click' => "startSorting('#{@trip.id}')", href: 'javascript:void(0);',
                      'ng-disabled' => 'reloading'}
                        = inline_svg 'buttons/reorder.svg'
                  .activity-action-link{'ng-hide' => 'edit'}
                    %a.link-with-icon{'ng-click' => "startEdit()",
                    'ng-disabled' => 'reloading', href: 'javascript:void(0);'}
                      = inline_svg 'buttons/edit.svg'
                  .activity-action-link{'ng-show' => 'edit && !whole_plan_edit'}
                    %a.link-with-icon.btn.btn-sm.btn-success{'ng-click' => 'save()', href: 'javascript:void(0);', 'ng-disabled' => 'saving'}
                      = inline_svg 'buttons/check.svg'
                  .activity-action-link{'ng-show' => 'edit && !whole_plan_edit'}
                    %a.link-with-icon.btn.btn-sm.ghost-button{'ng-click' => 'cancelEdit()', href: 'javascript:void(0);', 'ng-disabled' => 'saving'}
                      = inline_svg 'buttons/back.svg'

          .row.activity-day-places
            =# Show places
            .col-md-12{'ng-hide' => 'edit'}
              .activity-day-place{'ng-show' => 'place.city_text && place.flag_image && !edit && !day_edit',
                'ng-repeat' => 'place in day.places track by place.id'}
                %span{'ng-bind-html' => 'place.flag_image'}
                {{place.city_text}}

            =# Edit places
            .col-md-12.activity-day-places-edit{'ng-show' => 'edit'}
              .activity-day-place-edit.form-inline{'ng-repeat' => 'place in day.places track by place.id'}
                .form-group
                  = render 'widgets/typeahead/cities', model_name: 'place.city', classes: 'input-sm form-control',
                    placeholder: t('trips.show.city'),
                    custom_bindings: "'place.flag_image' : 'flag_image'",
                    allow_empty_typeahead: true

                  %a{href: 'javascript:void(0);', 'ng-click' => 'remove(day.places, $index)',
                        'ng-show' => 'day.places.length > 1'}
                    = image_tag 'buttons/delete.svg'

              .activity-day-place-edit.form-inline
                .form-group
                  %a.link-with-icon{href: 'javascript:void(0);', 'ng-click' => 'add(day.places, {})'}
                    = inline_svg 'buttons/add_plain.svg'
                    = t('trips.show.add_city')

          =# comment
          .row.activity-day-info
            .col-xs-12{'ng-show' => 'day.comment || edit'}
              .activity-day-comment{'ng-hide' => 'edit'}
                %p.travel-text{} {{day.comment}}
              .activity-day-comment{'ng-show' => 'edit'}
                = text_area_tag 'day_comment', '', 'ng-model' => 'day.comment', class: 'form-control',
                  placeholder: t('trips.show.comment'), rows: 4

          =# expenses and links
          .row.activity-day-info
            .col-md-6.col-xs-12.activity-day-add-info{'ng-show' => 'expensesPresent() || bookmarksPresent() || edit'}
              .activity-day-expenses
                .activity-day-expense{'ng-repeat' => 'expense in day.expenses track by expense.id', 'ng-hide' => 'edit'}
                  %span{'ng-show' => '!!expense.amount_cents'}
                    {{expense.name}}
                    {{expense.amount_cents / 100.0 | number: 2}}
                    {{expense.amount_currency_text}}
                    %i{'ng-show' => '!!expense.in_user_currency.amount_cents'}
                      ({{expense.in_user_currency.amount_cents / 100.0 | number: 2}} {{expense.in_user_currency.amount_currency_text}})

                .activity-day-expense-edit{'ng-repeat' => 'expense in day.expenses track by expense.id', 'ng-show' => 'edit'}
                  = text_field_tag 'expense_name', '', 'ng-model' => 'expense.name', class: 'form-control input-sm expense-name',
                      placeholder: t('trips.show.expense')
                  = render 'widgets/price', name: 'expense_price', placeholder: t('trips.show.price'),
                    object_model: 'expense'
                  %a.delete-expense{href: 'javascript:void(0);', 'ng-click' => 'remove(day.expenses, $index)',
                      'ng-show' => 'day.expenses.length > 1'}
                    = image_tag 'buttons/delete.svg'
                .activity-day-expense-edit{'ng-show' => 'edit'}
                  %a.link-with-icon{href: 'javascript:void(0);',
                      'ng-click' => "add(day.expenses, {#{default_currency_hash(@trip, current_user)}})"}
                    = inline_svg 'buttons/add_plain.svg'
                    = t('trips.show.add_expense')
              .activity-day-bookmarks
                .activity-day-bookmark{'ng-repeat' => 'link in day.links track by link.id', 'ng-hide' => 'edit'}
                  = render 'widgets/link_show', ng_model_url: 'link.url', ng_model_description: 'link.description'

                .activity-day-bookmark-edit{'ng-repeat' => 'link in day.links track by link.id', 'ng-show' => 'edit'}
                  = render 'widgets/link', ng_model_descr: 'link.description', ng_model_url: 'link.url', ng_array: 'day.links'

                .activity-day-bookmark-edit{'ng-show' => 'edit'}
                  %a.link-with-icon{href: 'javascript:void(0);', 'ng-click' => 'add(day.links)'}
                    = inline_svg 'buttons/add_plain.svg'
                    = t('trips.show.add_link')


          .activity-day-activities-header{'ng-if' => 'edit', 'ng-click' => 'triggerShowMore()'}
            = t('trips.show.activities')

          .activities-container{'ng-model' => 'day.activities',
          'ui-sortable' => "{connectWith: '.activities-container', placeholder: 'well', handle: '.activity-drag-handle', update: onDragFinish, disabled: !#{@user_can_edit}}"}
            .activity-info{'ng-repeat' => 'activity in day.activities track by activity.id'}
              %span{'ng-controller' => 'ActivityController', 'ng-init' => 'init(activity)'}
                %div{'ng-if' => '!edit'}
                  .row.activity-header{'ng-class' => '{high: activity.rating == 3, low: activity.rating == 1}'}
                    .col-md-12
                      %span{'ng-click' => 'triggerShowMore()'}
                        %span.activity-drag-handle{'ng-show' => 'day.activities.length > 1'}
                          - if @user_can_edit
                            = image_tag 'buttons/drag.svg', class: 'activity-drag-image hidden-xs hidden-sm'
                          {{$index+1}}.
                        {{activity.name}}
                        {{activity.amount_cents / 100.0 | number: 2}}
                        {{activity.amount_currency_text}}
                        %i{'ng-show' => '!!activity.in_user_currency.amount_cents'}
                          ({{activity.in_user_currency.amount_cents / 100.0 | number: 2}} {{activity.in_user_currency.amount_currency_text}})

                      - if @trip.days.count > 1 && @user_can_edit
                        %a.move-activity.hidden-xs{href: 'javascript:void(0);',
                          'uib-popover-template' => "'moveActivity.html'",
                          'popover-trigger' => "'outsideClick'",
                          'popover-placement' => 'top',
                          'popover-title' => t('trips.show.move_activity')}
                          = image_tag 'buttons/reorder.svg'

                  %div{'ng-show' => 'showMore()'}
                    .row.activity-link
                      .col-md-12
                        = render 'widgets/link_show', ng_model_url: 'activity.link_url', ng_model_description: 'activity.link_description'
                    .row{'ng-show' => 'activity.address'}
                      .col-md-12
                        %i
                          = t('trips.show.address').mb_chars.capitalize + ":"
                          {{activity.address}}
                    .row{'ng-show' => 'activity.working_hours'}
                      .col-md-12
                        %i
                          = t('trips.show.working_hours').mb_chars.capitalize + ":"
                          {{activity.working_hours}}
                    .row.activity-comment
                      .col-md-12
                        .travel-text {{activity.comment}}
                        %span{'ng-show' => '!activity.comment'}
                          = t('common.no_comments')

                .row{'ng-if' => 'edit'}
                  .col-md-4.col-xs-12.activity-edit
                    .activity-edit-row.activity-edit-header
                      %big.activity-drag-handle
                        = image_tag 'buttons/drag.svg', class: 'activity-drag-image hidden-xs hidden-sm'
                        {{$index+1}}.
                      = text_field_tag 'activity_name', '', 'ng-model' => 'activity.name', class: 'input-sm form-control',
                        placeholder: t('trips.show.activity.name')

                      %a.delete-activity{href: 'javascript:void(0);', 'ng-click' => 'remove(day.activities, $index)'}
                        = image_tag 'buttons/delete.svg'

                      - if @trip.days.count > 1
                        %a.move-activity.hidden-xs{href: 'javascript:void(0);',
                          'uib-popover-template' => "'moveActivity.html'",
                          'popover-trigger' => "'outsideClick'",
                          'popover-placement' => 'top',
                          'popover-title' => t('trips.show.move_activity')}
                          = image_tag 'buttons/reorder.svg'

                      %a.activity-show-more{'ng-class' => '{active: show_more}', 'ng-click' => 'triggerShowMore()'}
                        = inline_svg 'common/eye.svg', class: 'activity-show-more-img'
                    %div{'ng-show' => 'showMore()'}
                      .activity-edit-row.activity-ratings
                        .activity-rating{'ng-class' => '{selected: activity.rating == 3}',
                                         'ng-click' => 'activity.rating = 3'}
                          .activity-stars
                            = image_tag 'activities/star.svg'
                            = image_tag 'activities/star.svg'
                            = image_tag 'activities/star.svg'
                          .activity-text
                            = t('trips.show.activity_must_see')
                        .activity-rating{'ng-class' => '{selected: activity.rating == 2}',
                                         'ng-click' => 'activity.rating = 2'}
                          .activity-stars
                            = image_tag 'activities/star.svg'
                            = image_tag 'activities/star.svg'
                          .activity-text
                            = t('trips.show.activity_nice_to_visit')
                        .activity-rating{'ng-class' => '{selected: activity.rating == 1}',
                                         'ng-click' => 'activity.rating = 1'}
                          .activity-stars
                            = image_tag 'activities/star.svg'
                          .activity-text
                            = t('trips.show.activity_not_necessary')

                      .activity-edit-row
                        = render 'widgets/price', name: 'activity_price', object_model: 'activity',
                                                  placeholder: t('trips.show.price')
                      .activity-edit-row
                        = render 'widgets/link', ng_model_url: 'activity.link_url'
                      .activity-edit-row.activity-address-edit
                        %div.input-group
                          %span.input-group-addon
                            = image_tag 'activities/address.svg'
                          = text_field_tag 'activity_address', '', 'ng-model' => 'activity.address', class: "input-sm form-control",
                                            placeholder: t('trips.show.address')
                      .activity-edit-row.activity-working-hours-edit
                        %div.input-group
                          %span.input-group-addon
                            = image_tag 'activities/clock.svg'
                          = text_field_tag 'activity_working_hours', '', 'ng-model' => 'activity.working_hours', class: "input-sm form-control",
                                            placeholder: t('trips.show.working_hours')

                  .col-md-8.col-xs-12{'ng-show' => 'showMore()'}
                    = text_area_tag 'activity_comment', '', 'ng-model' => 'activity.comment', class: 'form-control',
                      placeholder: t('trips.show.comment'), rows: 9

          .activity-day-activities-footer{'ng-show' => 'edit'}
            %a.link-with-icon.add-activity-link{href: 'javascript:void(0);',
                'ng-click' => "add(day.activities, new_activity_template)"}
              = inline_svg 'buttons/add_plain.svg'
              = t('trips.show.add_activity')

          .activity-day-activities-footer{'ng-show' => 'edit && !whole_plan_edit'}
            .activity-action-link.no-margin
              %a.link-with-icon.btn.btn-sm.btn-success{'ng-click' => 'save()', href: 'javascript:void(0);', 'ng-disabled' => 'saving'}
                = inline_svg 'buttons/check.svg'
                %span.hidden-xs
                  = t('common.save')
            .activity-action-link
              %a.link-with-icon.btn.btn-sm.ghost-button{'ng-click' => 'cancelEdit()', href: 'javascript:void(0);', 'ng-disabled' => 'saving'}
                = inline_svg 'buttons/back.svg'
                %span.hidden-xs
                  = t('common.back')

          .activity-empty-state{'ng-show' => 'day.activities.length == 0 && !edit'}
            .activity-empty-state-header
              %span
                = t('trips.show.no_activities')

        .activity-mockup{'ng-hide' => 'day_loaded'}
          .row
            .col-md-12
              .activity-mockup-day-header
          .row
            .col-md-12
              .activity-mockup-day-places
                .activity-mockup-day-places-place
                .activity-mockup-day-places-place
          .row.activity-mockup-day-info-expenses
            .col-md-3.col-xs-12
              .activity-mockup-day-info-expenses-line
              .activity-mockup-day-info-expenses-line
              .activity-mockup-day-info-expenses-line
            .col-md-9.col-xs-12.activity-mockup-day-info-comment
              .activity-mockup-day-info-comment-line
              .activity-mockup-day-info-comment-line
              .activity-mockup-day-info-comment-line
          .row
            .col-md-12
              .activity-mockup-header
          .row
            .col-md-12
              .activity-mockup-header
          .row
            .col-md-12
              .activity-mockup-header
  .post-activities-init{'ng-init' => "initActivities('#{@trip.id}')"}